<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>Rotabrix</title>
    <style>
        /* T√úM ELEMENTLER ƒ∞√áƒ∞N TIKLAMA RENGƒ∞Nƒ∞ KAPAT (MAVƒ∞ KUTU) */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
            /* MOBƒ∞LDE BASILI TUTMAYI ENGELLE */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        canvas {
            display: block;
            position: absolute; /* Eklendi */
            top: 0;
            left: 0;
            width: 100%;  /* Zorla kapla */
            height: 100%; /* Zorla kapla */
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            cursor: grab;
            touch-action: none; /* Kaydƒ±rmayƒ± engelle */
            -webkit-touch-callout: none;
        }

        canvas:active {
            cursor: grabbing;
        }

        /* ORTAK BUTON STƒ∞LLERƒ∞ */
        button, input {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            outline: none;
            border: none;
            transition: transform 0.1s, box-shadow 0.2s, background-color 0.2s, border-color 0.2s, opacity 0.3s;
        }
        button { cursor: pointer; }
        button:active { transform: scale(0.95); }

        .glass-btn {
            width: 220px;
            padding: 15px;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        #startBtn {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border: none;
            color: white;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
        }
        #startBtn:hover {
            background: linear-gradient(45deg, #3a7bd5, #00d2ff);
        }
        #startScreen, #settingsScreen, #infoScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.98); 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
        }

        #gameTitle {
            font-size: 40px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.6), 0 0 40px rgba(0, 255, 255, 0.3);
            background: -webkit-linear-gradient(#00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        #highScoreDisplay {
            font-size: 18px;
            color: #f1c40f; 
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            letter-spacing: 1px;
            display: none; 
        }

        /* Nickname Alanƒ± Stilleri */
        .nickname-container {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #nicknameInput {
            width: 220px;
            padding: 12px;
            text-align: center;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ff9f43; 
            font-weight: bold;
            border-radius: 8px;
            margin-top: 5px;
        }
        #nicknameInput::placeholder { color: rgba(255, 255, 255, 0.4); font-weight: normal; }
        
        #nicknameShow {
            font-size: 26px; 
            color: #ff9f43;  
            font-weight: 900;
            text-shadow: 0 0 15px rgba(255, 159, 67, 0.4);
            cursor: pointer;
            letter-spacing: 1px;
            transition: transform 0.2s;
        }
        #nicknameShow:hover { 
            transform: scale(1.1);
            text-decoration: none; 
        }

        /* --- Dƒ∞L SE√áƒ∞M BUTONLARI --- */
        .lang-toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .lang-btn {
            background: rgba(255,255,255,0.1);
            color: #888;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid transparent;
            outline: none !important; 
        }
        .lang-btn:focus {
            outline: none;
        }
        
        .lang-btn.active {
            background: #00d2ff;
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
        }
        .lang-btn:hover:not(.active) {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        /* --- AYARLAR & Bƒ∞LGƒ∞ EKRANI STƒ∞LLERƒ∞ --- */
        .settings-section, .info-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%; 
            max-width: 340px; 
            box-sizing: border-box; 
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* KAYDIRMA (SCROLL) D√úZENLEMESƒ∞ */
        #infoContent {
            max-height: 70vh;
            overflow-y: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            /* Mobilde kaydƒ±rmayƒ± aktifle≈ütir */
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Ayarlar men√ºs√ºn√ºn de kaydƒ±rƒ±labilir olmasƒ± i√ßin d√ºzenleme */
        #settingsScrollArea {
            max-height: 70vh;
            overflow-y: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 10px;
            /* Mobilde kaydƒ±rmayƒ± aktifle≈ütir */
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }

        #infoContent::-webkit-scrollbar, #settingsScrollArea::-webkit-scrollbar { width: 6px; }
        #infoContent::-webkit-scrollbar-thumb, #settingsScrollArea::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .settings-title, .info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ddd;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
            width: 100%;
            text-align: center;
        }
        
        /* Zorluk kapsayƒ±cƒ±sƒ± */
        #difficultyContainer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }

        /* Kapsayƒ±cƒ± Kutusu */
    .diff-option {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 10px;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 15px 10px;
        cursor: pointer;
        
        /* Flexbox ile tam ortalama */
        display: flex;
        flex-direction: column;
        align-items: center;    /* Yatay eksende ortalar */
        justify-content: center; /* Dikey eksende ortalar */
    }

    .diff-option:hover { background: rgba(255,255,255,0.1); }
    
    .diff-option.selected {
        background: rgba(0, 210, 255, 0.15);
        border: 1px solid #00d2ff;
        box-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
    }

    /* Ba≈ülƒ±k Yazƒ±sƒ± */
    .diff-name {
        font-weight: bold;
        font-size: 16px;
        color: #fff;
        margin: 0 0 8px 0 !important; /* Altƒ±na biraz bo≈üluk, saƒüa sola 0 */
        text-align: center;
        width: 100%;
    }

    /* ƒ∞konlarƒ±n Grubu */
    .diff-preview {
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* Grubu tam ortaya alƒ±r */
        align-items: center;
        gap: 4px; /* ƒ∞konlar arasƒ±nda e≈üit bo≈üluk */
        width: 100%;
        padding: 0;
        margin: 0;
    }

    /* Mƒ∞Nƒ∞K ƒ∞KONLAR - Asƒ±l D√ºzeltme Burada */
    .mini-icon {
        
        margin: 0 !important;        /* √ñnceki kodlardan gelen saƒü bo≈üluƒüu siler */
        transform: none !important;  /* Scale'i iptal et, layout bozulmasƒ±n */
        font-size: 20px !important;  /* ƒ∞√ßindeki yazƒ±yƒ± k√º√ß√ºlt */
        border-width: 2px !important;
        flex-shrink: 0;              /* K√º√ß√ºl√ºp ezilmesini engelle */
    }



        .palette-option {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
            background: rgba(0,0,0,0.2);
            box-sizing: border-box;
        }
        .palette-option:hover { background: rgba(255,255,255,0.1); }
        .palette-option.selected {
            background: rgba(0, 210, 255, 0.2);
            border: 1px solid #00d2ff;
        }
        
        .color-preview-row { display: flex; gap: 5px; }
        .color-dot {
            width: 22px; height: 22px; border-radius: 50%;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .palette-name { font-size: 14px; font-weight: bold; color: #aaa; margin-right: 10px; }

        .toggle-btn {
            width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px;
            font-weight: bold; display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box;
        }
        .toggle-on { background: rgba(46, 213, 115, 0.2); color: #2ed573; border: 1px solid #2ed573; }
        .toggle-off { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid #ff4757; }

        .info-item {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
            text-align: left;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .brick-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .info-text { font-size: 14px; color: #eee; line-height: 1.3; flex: 1; }
        .info-text strong { color: #00d2ff; display: block; margin-bottom: 2px; }

        .icon-normal { background: #40E0D0; }
        .icon-star { 
            background: #222; 
            border: 2px solid #FFD700; 
            color: #FFD700; 
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); 
            font-size: 20px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-star::after { content: "‚òÖ"; }
        
        .icon-multi {
            background: radial-gradient(circle, #004444 0%, #001122 100%);
            border: 2px solid #00FFFF; color: #fff;
        }
        .icon-multi::after { content: "x1"; }

        .icon-laser {
            background: #220000; border: 2px solid #FF0000;
        }
        .icon-laser::before {
            content: ""; position: absolute; width: 24px; height: 4px; background: #fff;
            box-shadow: 0 0 5px #ff0000;
        }
        .icon-laser::after {
            content: ""; position: absolute; width: 4px; height: 24px; background: #fff;
            box-shadow: 0 0 5px #ff0000;
        }

    .icon-time {
        background: #002200; 
        border: 2px solid #00FF00;
        position: relative;
        background-image: 
            radial-gradient(circle, #00FF00 2px, transparent 2.5px),
            radial-gradient(circle, #00FF00 2px, transparent 2.5px),
            radial-gradient(circle, #00FF00 2px, transparent 2.5px),
            radial-gradient(circle, #00FF00 2px, transparent 2.5px);
        background-size: 6px 6px;
        background-position: 50% 0, 100% 50%, 50% 100%, 0 50%;
        background-repeat: no-repeat;
    }
    .icon-time::before {
        content: ""; position: absolute; top: 50%; left: 50%; width: 2px; height: 10px; background: #fff; 
        transform: translate(-50%, -100%); border-radius: 1px;
    }
    .icon-time::after {
        content: ""; position: absolute; top: 50%; left: 50%; width: 2px; height: 9px; background: #fff; 
        transform-origin: top center; transform: translate(-50%, 0) rotate(-65deg); border-radius: 1px;
    }

        .icon-bomb {
            background: #333; border: 2px solid #FF4500;
        }
        .icon-bomb::after {
            content: ""; width: 12px; height: 12px; background: #FF4500; border-radius: 50%;
        }

        .icon-death {
            background: radial-gradient(#880000, #220000); border: 2px solid #FF0000; color: white;
        }
        .icon-death::after { content: "-1"; }

        .icon-ice-boss {
            background: #2c3e50;
            border: 2px solid #00FFFF;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-ice-boss::after {
            content: "‚ùÑ"; 
            color: white;
            font-size: 28px;
            text-shadow: 0 0 8px #00FFFF;
            line-height: 1;
        }

        .icon-lightning-boss {
            background: #2c2c2c;
            border: 2px solid #FFFF00;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.6);
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-lightning-boss::after {
            content: "‚ö°";
            color: #FFFF00;
            font-size: 18px; 
            text-shadow: 0 0 8px #FFFF00;
            line-height: 1;
        }

        .icon-fire-boss {
            background: #3e0c0c;
            border: 2px solid #FF4500; 
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.6);
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .icon-fire-boss::after {
            content: "üî•";
            font-size: 24px;
            text-shadow: 0 0 8px #FF4500;
            line-height: 1;
        }

        .icon-rainbow {
            background: conic-gradient(
                #40E0D0 0deg 60deg, #800080 60deg 120deg, #008000 120deg 180deg,
                #FF0000 180deg 240deg, #FFFF00 240deg 300deg, #0000FF 300deg 360deg
            );
            border: 2px solid white;
        }
        .icon-rainbow::before {
            content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 35%; height: 35%; background-color: white; border-radius: 50%;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .icon-turnbomb { 
            background: #1a1a1a; 
            border: 2px solid #FF4500;
            position: relative;
            overflow: visible;
        }
        .icon-turnbomb::before {
            content: ""; position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            width: 16px; height: 16px; background: #1a1a1a; border: 2px solid #fff; border-radius: 50%; z-index: 2;
        }
        .icon-turnbomb::after {
            content: ""; position: absolute; top: 15%; left: 50%; width: 10px; height: 10px;
            border-top: 2px solid #FFA500; border-right: 1px solid #FFA500; border-radius: 0 100% 0 0;
            box-shadow: -4px 2px 0 0px #7f8c8d; transform: translateX(2px); z-index: 1;
        }

    .icon-launch {
        background: #2c3e50;
        border: 2px solid #3498db;
        position: relative;
    }
    .icon-launch::before {
        content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -8px);
        width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #3498db;
    }
    .icon-launch::after {
        content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, 5px);
        width: 6px; height: 6px; background-color: #3498db; border-radius: 50%;
    }

        #detonateBtn {
            position: absolute; bottom: 150px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: #1a1a1a; border: 3px solid #FF4500;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 15; opacity: 0.3; transition: all 0.3s ease; overflow: visible;
        }
        #detonateBtn::before {
            content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 22px; height: 22px; background: #1a1a1a; border: 3px solid #fff; border-radius: 50%; z-index: 2;
        }
        #detonateBtn::after {
            content: ""; position: absolute; top: 12%; left: 50%; width: 14px; height: 14px;
            border-top: 3px solid #FFA500; border-right: 2px solid #FFA500; border-radius: 0 100% 0 0;
            box-shadow: -4px 2px 0 0px #7f8c8d; transform: translateX(1px); z-index: 1;
        }
        .detonate-active {
            opacity: 0.7 !important; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 69, 0, 0.6) !important;
            animation: pulseBtn 1s infinite alternate;
        }

        #launchBallBtn {
            position: absolute; bottom: 225px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: #1a1a1a; border: 3px solid #3498db;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 15; opacity: 0.3; transition: all 0.3s ease;
            color: #3498db; font-size: 24px; font-weight: bold;
        }
        #launchBallBtn::before {
            content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; background: #1a1a1a; border: 3px solid #fff; border-radius: 50%; z-index: 2;
        }
         #launchCountBadge {
            position: absolute; top: -5px; left: -5px; 
            background: #e74c3c;
            color: white; font-size: 12px; width: 20px; height: 20px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            border: 1px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .launch-active {
            opacity: 0.7 !important; cursor: pointer;
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.6) !important;
        }

        @keyframes pulseBtn { from { transform: scale(1); } to { transform: scale(1.1); } }

        .confetti-piece {
            position: fixed; top: -20px; width: 10px; height: 10px;
            z-index: 100; pointer-events: none; animation: fall linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        #uiContainer {
            position: absolute; top: 50%; left: 20px; transform: translateY(-50%);
            display: none; flex-direction: column; align-items: flex-start;
            gap: 15px; z-index: 5; pointer-events: none; opacity: 0.6; 
        }

        .ui-group { display: flex; flex-direction: column; align-items: flex-start; }
        .ui-label { font-size: 12px; font-weight: bold; letter-spacing: 1px; margin-bottom: 2px; text-transform: uppercase; opacity: 0.8; color: #fff; }
        .ui-value { font-size: 28px; font-weight: 900; line-height: 1; text-shadow: 0 0 10px rgba(0,0,0,0.5); font-variant-numeric: tabular-nums; }

        #timeLabel, #timerDisplay { color: #00FF00; text-shadow: 0 0 10px rgba(0, 255, 0, 0.4); }
        #scoreLabel, #scoreDisplay { color: #FFFFFF; text-shadow: 0 0 10px rgba(255, 255, 255, 0.4); }
        #ballLabel, #ballDisplay { color: #747d8c; text-shadow: none; }

        .low-time {
            color: #ff4757 !important;
            text-shadow: 0 0 10px rgba(255, 71, 87, 0.6) !important;
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
            color: white; opacity: 0; transition: opacity 0.5s ease-in;
        }

        #gameResultTitle {
            font-size: 35px; margin-bottom: 30px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5); text-align: center;
        }
        
        .win-title { color: #2ed573; text-shadow: 0 0 20px rgba(46, 213, 115, 0.6) !important; }
        .lose-title { color: #ff4757; text-shadow: 0 0 20px rgba(255, 71, 87, 0.6) !important; }

        .score-details-container {
            display: none; flex-direction: column; gap: 10px; margin-bottom: 30px;
            text-align: center; font-size: 18px; color: #ccc;
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;
            width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .total-score-line {
            font-size: 32px; font-weight: bold; color: #fff; margin-top: 15px;
            padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        #restartBtn { background-color: #f1c40f; color: #1a1a1a; border-color: #f39c12; }
        #restartBtn:hover { background-color: #d4ac0d; }

    </style>
</head>
<body>

    <!-- Gƒ∞Rƒ∞≈û EKRANI -->
    <div id="startScreen">
        <div id="gameTitle">ROTABRIX</div>
        
        <div id="highScoreDisplay"></div> 
        
        <div class="nickname-container">
            <input type="text" id="nicknameInput" placeholder="ENTER NICKNAME" maxlength="14" data-lang-placeholder="nicknamePlaceholder">
            <span id="nicknameShow" style="display:none;"></span>
        </div>

        <button id="infoBtn" class="glass-btn" data-lang-key="howToPlayBtn">HOW TO PLAY?</button>
        <button id="settingsBtn" class="glass-btn" data-lang-key="settingsBtn">SETTINGS</button>
        <button id="startBtn" class="glass-btn" data-lang-key="startBtn">START</button>
    </div>

    <!-- AYARLAR EKRANI -->
    <div id="settingsScreen" style="display:none;">
        <h2 style="font-size:32px; margin-bottom:20px;" data-lang-key="settingsTitle">SETTINGS</h2>
        
        <div id="settingsScrollArea">
            <div class="settings-section">
                <div class="settings-title" data-lang-key="colorThemeTitle">COLOR THEME</div>
                <div id="paletteContainer"></div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title" data-lang-key="audioSettingsTitle">AUDIO SETTINGS</div>
                <button id="bgMusicToggle" class="toggle-btn toggle-on">
                    <span data-lang-key="bgMusicLabel">Background Music</span> <span id="bgMusicStatus">ON</span>
                </button>
                <button id="sfxToggle" class="toggle-btn toggle-on">
                    <span data-lang-key="sfxLabel">SFX</span> <span id="sfxStatus">ON</span>
                </button>
            </div>

            <!-- ZORLUK SEVƒ∞YESƒ∞ EN ALTA ALINDI -->
            <div class="settings-section">
                <div class="settings-title" data-lang-key="difficultyTitle">DIFFICULTY</div>
                <div id="difficultyContainer" style="width:100%;">
                    <div class="diff-option" id="diffEasy" onclick="setDifficulty('easy')">
                        <div class="diff-name" data-lang-key="diffEasy">EASY</div>
                        <div class="diff-preview">
                            <div class="brick-icon mini-icon icon-normal"></div>
                            <div class="brick-icon mini-icon icon-time"></div>
                            <div class="brick-icon mini-icon icon-launch"></div>
                            <div class="brick-icon mini-icon icon-turnbomb"></div>
                            <div class="brick-icon mini-icon icon-death"></div>
                            <div class="brick-icon mini-icon icon-multi"></div>
                        </div>
                    </div>
                    <div class="diff-option" id="diffMedium" onclick="setDifficulty('medium')">
                        <div class="diff-name" data-lang-key="diffMedium">MEDIUM</div>
                        <div class="diff-preview">
                            <div class="brick-icon mini-icon icon-star"></div>
                            <div class="brick-icon mini-icon icon-laser"></div>
                            <div class="brick-icon mini-icon icon-bomb"></div>
                            <div class="brick-icon mini-icon icon-rainbow"></div>
                        </div>
                    </div>
                    <div class="diff-option selected" id="diffHard" onclick="setDifficulty('hard')">
                        <div class="diff-name" data-lang-key="diffHard">HARD</div>
                        <div class="diff-preview">
                             <div class="brick-icon mini-icon icon-fire-boss"></div>
                             <div class="brick-icon mini-icon icon-ice-boss"></div>
                             <div class="brick-icon mini-icon icon-lightning-boss"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button id="closeSettingsBtn" class="glass-btn" style="background:rgba(255,255,255,0.1); margin-top:10px;" data-lang-key="backBtn">BACK</button>
    </div>

    <!-- Bƒ∞LGƒ∞ / NASIL OYNANIR EKRANI -->
    <div id="infoScreen" style="display:none;">
        <div class="lang-toggle-container">
            <button class="lang-btn active" id="btnEN">EN</button>
            <button class="lang-btn" id="btnTR">TR</button>
        </div>
        <div id="infoContent">
            <div class="info-section">
                <div class="info-title" data-lang-key="generalRulesTitle">GENERAL RULES</div>
                <ul style="text-align:left; padding:0 10px; list-style-position: inside; color:#ccc; font-size:15px; margin:0;">
                    <li style="margin-bottom:5px;" data-lang-key="rule1">Rotate the hexagon to change ball color.</li>
                    <li style="margin-bottom:5px;" data-lang-key="rule2">Watch the timer. Collect time bonuses to gain extra time.</li>
                    <li style="margin-bottom:5px;" data-lang-key="rule3">You must break all bricks to win.</li>
                    <li style="margin-bottom:5px;" data-lang-key="rule4">If time runs out or all balls are lost, you lose.</li>
                </ul>
            </div>
            <div class="info-section">
                <div class="info-title" data-lang-key="brickFeaturesTitle">BRICK FEATURES</div>
                
                <div class="info-item">
                    <div class="brick-icon icon-normal"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickNormalTitle">Normal Brick</strong>
                        <span data-lang-key="brickNormalDesc">Gives +10 points when broken.</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-launch"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickLaunchTitle">Launch Grant Brick</strong>
                        <span data-lang-key="brickLaunchDesc">Grants a 'Ball Launch' right. Use button to fire a new ball!</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-turnbomb"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickTurnBombTitle">Ball-Bomb Brick</strong>
                        <span data-lang-key="brickTurnBombDesc">Turns the ball into a Bomb. Press the button to explode it!</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-star"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickStarTitle">Star Brick</strong>
                        <span data-lang-key="brickStarDesc">Turns ball into "Super Ball". Breaks any color brick.</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-multi"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickMultiTitle">Multiplier (x1, x2...)</strong>
                        <span data-lang-key="brickMultiDesc">Adds extra balls to the game. More balls, faster clear!</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-laser"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickLaserTitle">Laser</strong>
                        <span data-lang-key="brickLaserDesc">Destroys all bricks in vertical and horizontal axis.</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-time"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickTimeTitle">Time</strong>
                        <span data-lang-key="brickTimeDesc">Adds +30 seconds to your timer.</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-bomb"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickBombTitle">Bomb</strong>
                        <span data-lang-key="brickBombDesc">Explodes a large area. Starts a chain reaction!</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-rainbow"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickRainbowTitle">Rainbow</strong>
                        <span data-lang-key="brickRainbowDesc">Scatters 6 new balls, one of each color.</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="brick-icon icon-death"></div>
                    <div class="info-text">
                        <strong data-lang-key="brickEraserTitle">ERASER</strong>
                        <span data-lang-key="brickEraserDesc">Warning! The ball hitting this gets erased from game.</span>
                    </div>
                </div>

                <!-- BOSS (ZORLUK) √ñGELERƒ∞ EN ALTA TA≈ûINDI -->
                <div class="info-item">
                    <div class="brick-icon icon-fire-boss"></div>
                    <div class="info-text">
                        <strong data-lang-key="fireBossTitle">Inferno Lord</strong>
                        <span data-lang-key="fireBossDesc">Burns the ball instantly! Has 100 HP.</span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="brick-icon icon-ice-boss"></div>
                    <div class="info-text">
                        <strong data-lang-key="iceBossTitle">Frost Guardian</strong>
                        <span data-lang-key="iceBossDesc">Slows down the ball. Has 50 HP.</span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="brick-icon icon-lightning-boss"></div>
                    <div class="info-text">
                        <strong data-lang-key="lightningBossTitle">Volt Master</strong>
                        <span data-lang-key="lightningBossDesc">Speeds up the ball! Has 25 HP.</span>
                    </div>
                </div>

            </div>
        </div>
        <button id="closeInfoBtn" class="glass-btn" style="background:rgba(255,255,255,0.1); margin-top:10px;" data-lang-key="gotItBtn">GOT IT</button>
    </div>

    <!-- OYUN ARAY√úZ√ú -->
    <div id="uiContainer">
        <div class="ui-group">
            <div id="timeLabel" class="ui-label" data-lang-key="uiTime">TIME</div>
            <div id="timerDisplay" class="ui-value">100</div>
        </div>
        <div class="ui-group">
            <div id="scoreLabel" class="ui-label" data-lang-key="uiScore">SCORE</div>
            <div id="scoreDisplay" class="ui-value">0</div>
        </div>
        <div class="ui-group">
            <div id="ballLabel" class="ui-label" data-lang-key="uiBalls">BALLS</div>
            <div id="ballDisplay" class="ui-value">1</div>
        </div>
    </div>
    
    <button id="launchBallBtn">
        <div id="launchCountBadge">0</div>
    </button>
    <button id="detonateBtn"></button>

    <!-- OYUN SONU EKRANI -->
    <div id="gameOverScreen">
        <h1 id="gameResultTitle" data-lang-key="gameOverTitle">GAME OVER</h1>
        <div class="score-details-container" id="scoreDetailsBox">
            <div id="baseScoreDetail">Normal Score: 0</div>
            <div id="timeBonusDetail">Time Bonus (x10): 0</div>
            <div id="ballBonusDetail">Ball Bonus (x10): 0</div>
            <div id="launchBonusDetail">Launch Bonus (x50): 0</div>
            <div class="total-score-line" id="finalScoreDisplay">Total: 0</div>
            <div class="total-score-line" id="highScoreResultDisplay" style="font-size: 20px; color: #f1c40f; border:none; margin-top:5px; padding-top:0;"></div>
        </div>
        <button id="menuBtn" class="glass-btn" style="margin-bottom: 5px;" data-lang-key="returnMenuBtn">RETURN TO MENU</button>
        <button id="restartBtn" class="glass-btn" data-lang-key="playAgainBtn">PLAY AGAIN</button>
    </div>

    <canvas id="gameCanvas" oncontextmenu="return false;"></canvas>

<script>
    // --- Dƒ∞L VERƒ∞TABANI ---
    const translations = {
        gameTitle: { en: "ROTABRIX", tr: "ROTABRIX" },
        howToPlayBtn: { en: "HOW TO PLAY?", tr: "NASIL OYNANIR?" },
        settingsBtn: { en: "SETTINGS", tr: "AYARLAR" },
        startBtn: { en: "START", tr: "BA≈ûLAT" },
        nicknamePlaceholder: { en: "ENTER NICKNAME", tr: "NICKNAME Gƒ∞Rƒ∞N" },
        highScorePrefix: { en: "HIGH SCORE: ", tr: "EN Y√úKSEK SKOR: " },
        settingsTitle: { en: "SETTINGS", tr: "AYARLAR" },
        colorThemeTitle: { en: "COLOR THEME", tr: "RENK TEMASI" },
        audioSettingsTitle: { en: "AUDIO SETTINGS", tr: "SES AYARLARI" },
        bgMusicLabel: { en: "Background Music", tr: "Arkaplan Sesi" },
        sfxLabel: { en: "SFX", tr: "√áarpƒ±≈üma Sesi" },
        statusOn: { en: "ON", tr: "A√áIK" },
        statusOff: { en: "OFF", tr: "KAPALI" },
        backBtn: { en: "BACK", tr: "GERƒ∞ D√ñN" },
        generalRulesTitle: { en: "GENERAL RULES", tr: "GENEL KURALLAR" },
        rule1: { en: "Rotate the hexagon to change ball color.", tr: "Altƒ±geni √ßevirerek toplarƒ±n rengini deƒüi≈ütir." },
        rule2: { en: "Watch the timer. Collect time bonuses to gain extra time.", tr: "S√ºreyi takip et. S√ºre bonuslarƒ±nƒ± toplayarak, ek s√ºre kazan." },
        rule3: { en: "You must break all bricks to win.", tr: "Kazanmak i√ßin t√ºm tuƒülalarƒ± kƒ±rmalƒ±sƒ±n." },
        rule4: { en: "If time runs out or all balls are lost, you lose.", tr: "S√ºre biter veya toplarƒ±n tamamƒ± silinirse, oyunu kaybedersin." },
        brickFeaturesTitle: { en: "BRICK FEATURES", tr: "TUƒûLA √ñZELLƒ∞KLERƒ∞" },
        gotItBtn: { en: "GOT IT", tr: "ANLADIM" },
        brickTurnBombTitle: { en: "Ball-Bomb Brick", tr: "Bomba Top Tuƒülasƒ±" },
        brickTurnBombDesc: { en: "Turns ball into a Bomb. Press the button to explode it!", tr: "Topu Bombaya √ßevirir. Patlatmak i√ßin butona bas!" },
        brickLaunchTitle: { en: "Launch Grant Brick", tr: "Fƒ±rlatma Tuƒülasƒ±" },
        brickLaunchDesc: { en: "Grants a 'Ball Launch' right. Use button to fire a new ball! (+5)", tr: "Top Fƒ±rlatma Hakkƒ± verir. Butonu kullanarak yeni top fƒ±rlat! (+5)" },
        brickNormalTitle: { en: "Normal Brick", tr: "Normal Tuƒüla" },
        brickNormalDesc: { en: "Gives +10 points when broken.", tr: "Kƒ±rƒ±ldƒ±ƒüƒ±nda +10 puan verir." },
        brickStarTitle: { en: "Star Brick", tr: "Yƒ±ldƒ±z Tuƒülasƒ±" },
        brickStarDesc: { en: "Turns ball into 'Super Ball'. Breaks any color brick.",tr: "Topu 'S√ºper Top'a d√∂n√º≈üt√ºr√ºr. Her renk tuƒülayƒ± kƒ±rar." },
        brickMultiTitle: { en: "Multiplier", tr: "√áoƒüaltƒ±cƒ±" },
        brickMultiDesc: { en: "Adds extra balls to the game. More balls, faster clear! (x1, x2...)", tr: "Oyuna ekstra top ekler. Daha fazla top, daha hƒ±zlƒ± temizlik! (x1, x2...)" },
        brickLaserTitle: { en: "Laser", tr: "Lazer" },
        brickLaserDesc: { en: "Destroys all bricks in vertical and horizontal axis.", tr: "Dikey ve yatay eksendeki t√ºm tuƒülalarƒ± yok eder." },
        brickTimeTitle: { en: "Time", tr: "Zaman" },
        brickTimeDesc: { en: "Adds +30 seconds to your timer.", tr: "S√ºrene +30 saniye ekler."  },
        brickBombTitle: { en: "Bomb", tr: "Bomba" },
        brickBombDesc: { en: "Explodes a large area. Starts a chain reaction!", tr: "Geni≈ü bir alanƒ± patlatƒ±r. Zincirleme reaksiyon ba≈ülatƒ±r!" },
        brickRainbowTitle: { en: "Rainbow", tr: "G√∂kku≈üaƒüƒ±" },
        brickRainbowDesc: { en: "Scatters 6 new balls, one of each color.", tr: "Her renkten birer tane olmak √ºzere 6 yeni top sa√ßar." },
        brickEraserTitle: { en: "Eraser", tr: "Silici" },
        brickEraserDesc: { en: "Warning! The ball hitting this gets erased from game.", tr: "Dikkat! Bu tuƒülaya √ßarpan top silinir ve oyundan √ßƒ±kar." },
        
        // YENƒ∞ Dƒ∞L KEYLERƒ∞
        fireBossTitle: { en: "Inferno Lord", tr: "Alev Lordu" },
        fireBossDesc: { en: "Burns the ball instantly! Has 50 HP.", tr: "Topu anƒ±nda yakar! 50 canƒ± vardƒ±r." },
        iceBossTitle: { en: "Frost Guardian", tr: "Buz Muhafƒ±zƒ±" },
        iceBossDesc: { en: "Slows down the ball. Has 50 HP.", tr: "Topu dondurur ve yava≈ülatƒ±r. 50 canƒ± vardƒ±r." },
        lightningBossTitle: { en: "Volt Master", tr: "Volt Ustasƒ±" },
        lightningBossDesc: { en: "Speeds up the ball! Has 25 HP.", tr: "Topu hƒ±zlandƒ±rƒ±r! 25 canƒ± vardƒ±r." },
        floatLaunchGrant: { en: "+5 Launch", tr: "+5 Fƒ±rlatma" },

        difficultyTitle: { en: "DIFFICULTY", tr: "ZORLUK SEVƒ∞YESƒ∞" },
        diffEasy: { en: "EASY", tr: "KOLAY" },
        diffMedium: { en: "MEDIUM", tr: "ORTA" },
        diffHard: { en: "HARD", tr: "ZOR" },

        uiTime: { en: "TIME", tr: "S√úRE" },
        uiScore: { en: "SCORE", tr: "SKOR" },
        uiBalls: { en: "BALLS", tr: "TOPLAR" },
        floatZap: { en: "Zap!", tr: "Zap!" },
        floatBoom: { en: "BOOM!", tr: "BUM!" },
        floatStarPower: { en: "STAR POWER!", tr: "YILDIZ G√úC√ú!" },
        floatBallBomb: { en: "BOMB READY!", tr: "BOMBA HAZIR!" },
        floatLaunchGrant: { en: "+3 Launch", tr: "+3 Fƒ±rlatma" },
        floatRainbow: { en: "Rainbow", tr: "G√∂kku≈üaƒüƒ±" },
        floatLaser: { en: "Laser", tr: "Lazer" },
        floatBallLost: { en: "-1 Ball", tr: "-1 Top" },
        floatBallGain: { en: "+1 Ball", tr: "+1 Top" },
        gameOverTitle: { en: "GAME OVER", tr: "OYUN Bƒ∞TTƒ∞" },
        winTitle: { en: "YOU WON!", tr: "KAZANDIN!" },
        loseTitleTime: { en: "TIME UP", tr: "S√úRE Bƒ∞TTƒ∞" },
        loseTitleBalls: { en: "NO BALLS LEFT", tr: "TOPLAR Bƒ∞TTƒ∞" },
        returnMenuBtn: { en: "RETURN TO MENU", tr: "MEN√úYE D√ñN" },
        playAgainBtn: { en: "PLAY AGAIN", tr: "YENƒ∞DEN OYNA" },
        scoreNormal: { en: "Normal Score: ", tr: "Normal Skor: " },
        scoreTimeBonus: { en: "Time Bonus (x10): ", tr: "S√ºre Bonusu (x10): " },
        scoreBallBonus: { en: "Ball Bonus (x10): ", tr: "Top Bonusu (x10): " },
        scoreLaunchBonus: { en: "Launch Bonus (x50): ", tr: "Fƒ±rlatma Bonusu (x50): " },
        scoreTotal: { en: "Total: ", tr: "Toplam: " }
    };

    let currentLang = 'en'; 
    let currentDifficulty = 'hard'; // Default difficulty

    // Difficulty configurations (Allowed bricks per level)
    const difficultyConfig = {
        easy: ['normal', 'time', 'launch_grant', 'turn_bomb', 'death', 'multi'],
        medium: ['normal', 'time', 'launch_grant', 'turn_bomb', 'death', 'multi', 'star', 'laser', 'bomb', 'rainbow'],
        hard: ['normal', 'time', 'launch_grant', 'turn_bomb', 'death', 'multi', 'star', 'laser', 'bomb', 'rainbow', 'fire_boss', 'ice_boss', 'lightning_boss']
    };

    // --- DOM ELEMENTLERƒ∞ ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const startScreen = document.getElementById('startScreen');
    const settingsScreen = document.getElementById('settingsScreen');
    const infoScreen = document.getElementById('infoScreen'); 
    const uiContainer = document.getElementById('uiContainer');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const highScoreDisplay = document.getElementById('highScoreDisplay');
    
    const detonateBtn = document.getElementById('detonateBtn'); 
    const launchBallBtn = document.getElementById('launchBallBtn');
    const launchCountBadge = document.getElementById('launchCountBadge');

    const nicknameInput = document.getElementById('nicknameInput');
    const nicknameShow = document.getElementById('nicknameShow');

    const paletteContainer = document.getElementById('paletteContainer');
    const bgMusicToggle = document.getElementById('bgMusicToggle');
    const sfxToggle = document.getElementById('sfxToggle');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const closeInfoBtn = document.getElementById('closeInfoBtn'); 

    const btnEN = document.getElementById('btnEN');
    const btnTR = document.getElementById('btnTR');

    const startBtn = document.getElementById('startBtn');
    const infoBtn = document.getElementById('infoBtn'); 
    const settingsBtn = document.getElementById('settingsBtn');
    const restartBtn = document.getElementById('restartBtn');
    const returnMenuBtn = document.getElementById('menuBtn');
    
    const timerDisplay = document.getElementById('timerDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const ballDisplay = document.getElementById('ballDisplay');
    
    const gameResultTitle = document.getElementById('gameResultTitle');
    const scoreDetailsBox = document.getElementById('scoreDetailsBox');
    const baseScoreDetail = document.getElementById('baseScoreDetail');
    const timeBonusDetail = document.getElementById('timeBonusDetail');
    const ballBonusDetail = document.getElementById('ballBonusDetail');
    const launchBonusDetail = document.getElementById('launchBonusDetail');
    const finalScoreDisplay = document.getElementById('finalScoreDisplay');
    const highScoreResultDisplay = document.getElementById('highScoreResultDisplay');

    let width, height;
    
    const palettes = [
        { name: "HB1", colors: ['#40E0D0', '#800080', '#008000', '#FF0000', '#FFFF00', '#0000FF'] },
        { name: "HB2", colors: ['#FF00CC', '#00FFFF', '#39FF14', '#FFD700', '#FF4500', '#9900FF'] },
        { name: "HB3", colors: ['#E74C3C', '#3498DB', '#F1C40F', '#9B59B6', '#1ABC9C', '#BBE622'] }
    ];

    let currentPaletteIndex = 0;
    let baseColors = [...palettes[0].colors];
    
    let isMusicOn = true;
    let isSfxOn = true;

    // --- OYUN DURUM DEƒûƒ∞≈ûKENLERƒ∞ ---
    let gameState = 'MENU'; 
    let playerNickname = "";

    let balls = []; 
    let hexagon;
    let targets = [];
    let particles = []; 
    let lasers = []; 
    let bombBlasts = [];
    let floatingTexts = [];
    
    let animationId;
    let gameInterval; 

    let hexHitCount = 0; 
    const ROW_HEIGHT = 75; 

    let totalBricksAdded = 0; 
    
    // Tuƒüla Spawn Flagleri
    let pendingDeathBrick = false;
    let pendingMultiBrick = false; 
    let pendingLaserBrick = false; 
    let pendingRainbowBrick = false;
    let pendingTimeBrick = false; 
    let pendingBombBrick = false;
    let pendingStarBrick = false; 
    let pendingTurnBombBrick = false;
    let pendingLaunchBrick = false;

    let ballLaunchRights = 0;

    let gameTime = 100.0; 
    let score = 0;          
    let displayedScore = 0; 
    let lastTime = 0;

    let isDragging = false;
    let lastMouseAngle = 0;

    // --- EVENT LISTENERLAR ---

    btnEN.addEventListener('click', () => setLanguage('en'));
    btnTR.addEventListener('click', () => setLanguage('tr'));

    startBtn.addEventListener('click', () => { 
        handleNicknameSave();
        startGame(); 
    });
    
    nicknameShow.addEventListener('click', () => {
        nicknameInput.style.display = 'block';
        nicknameShow.style.display = 'none';
        nicknameInput.value = playerNickname;
        nicknameInput.focus();
    });

    restartBtn.addEventListener('click', () => { startGame(); });
    returnMenuBtn.addEventListener('click', () => { showMenu(); });

    infoBtn.addEventListener('click', () => {
        startScreen.style.display = 'none';
        infoScreen.style.display = 'flex';
    });
    
    closeInfoBtn.addEventListener('click', () => {
        infoScreen.style.display = 'none';
        startScreen.style.display = 'flex';
    });

    settingsBtn.addEventListener('click', openSettings);
    closeSettingsBtn.addEventListener('click', closeSettings);
    
    bgMusicToggle.addEventListener('click', () => toggleAudio('music'));
    sfxToggle.addEventListener('click', () => toggleAudio('sfx'));

    detonateBtn.addEventListener('click', detonateAllBombBalls);
    launchBallBtn.addEventListener('click', launchExtraBall);

    // --- FONKSƒ∞YONLAR ---
    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('hexBreakerLang', lang);

        if (lang === 'en') {
            btnEN.classList.add('active');
            btnTR.classList.remove('active');
        } else {
            btnTR.classList.add('active');
            btnEN.classList.remove('active');
        }

        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (translations[key]) {
                el.innerText = translations[key][lang];
            }
        });

        document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-placeholder');
            if (translations[key]) {
                el.placeholder = translations[key][lang];
            }
        });

        updateAudioButtons();
        
        if (highScoreDisplay.style.display !== 'none') {
             const currentText = highScoreDisplay.innerText;
             const scorePart = currentText.split(':')[1] || " 0";
             highScoreDisplay.innerText = translations['highScorePrefix'][lang] + scorePart;
        }
    }

    function getText(key) {
        if(translations[key] && translations[key][currentLang]) {
            return translations[key][currentLang];
        }
        return key; 
    }

    function openSettings() {
        startScreen.style.display = 'none';
        settingsScreen.style.display = 'flex';
        renderPaletteSelector();
        updateAudioButtons();
        // Highlight current difficulty
        document.querySelectorAll('.diff-option').forEach(opt => opt.classList.remove('selected'));
        if(currentDifficulty === 'easy') document.getElementById('diffEasy').classList.add('selected');
        else if(currentDifficulty === 'medium') document.getElementById('diffMedium').classList.add('selected');
        else document.getElementById('diffHard').classList.add('selected');
    }

    function closeSettings() {
        settingsScreen.style.display = 'none';
        startScreen.style.display = 'flex';
    }

    function setDifficulty(level) {
        currentDifficulty = level;
        localStorage.setItem('hexBreakerDifficulty', level);
        openSettings(); // Refresh UI
    }

    function renderPaletteSelector() {
        paletteContainer.innerHTML = '';
        palettes.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = `palette-option ${index === currentPaletteIndex ? 'selected' : ''}`;
            div.onclick = () => selectPalette(index);
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'palette-name';
            nameSpan.innerText = p.name;
            div.appendChild(nameSpan);

            const row = document.createElement('div');
            row.className = 'color-preview-row';
            p.colors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = c;
                row.appendChild(dot);
            });
            div.appendChild(row);
            paletteContainer.appendChild(div);
        });
    }

    function selectPalette(index) {
        currentPaletteIndex = index;
        baseColors = [...palettes[index].colors];
        localStorage.setItem('hexBreakerPalette', index);
        renderPaletteSelector();
    }

    function toggleAudio(type) {
        if (type === 'music') {
            isMusicOn = !isMusicOn;
            localStorage.setItem('hexBreakerMusic', isMusicOn);
        } else if (type === 'sfx') {
            isSfxOn = !isSfxOn;
            localStorage.setItem('hexBreakerSfx', isSfxOn);
        }
        updateAudioButtons();
    }

    function updateAudioButtons() {
        const bgLabel = document.getElementById('bgMusicStatus');
        const sfxLabel = document.getElementById('sfxStatus');

        if (isMusicOn) {
            bgMusicToggle.className = 'toggle-btn toggle-on';
            bgLabel.innerText = translations['statusOn'][currentLang];
        } else {
            bgMusicToggle.className = 'toggle-btn toggle-off';
            bgLabel.innerText = translations['statusOff'][currentLang];
        }

        if (isSfxOn) {
            sfxToggle.className = 'toggle-btn toggle-on';
            sfxLabel.innerText = translations['statusOn'][currentLang];
        } else {
            sfxToggle.className = 'toggle-btn toggle-off';
            sfxLabel.innerText = translations['statusOff'][currentLang];
        }
    }
    
    function playSoundEffect(type) {
        if (!isSfxOn) return;
    }

    function loadUserData() {
        const storedName = localStorage.getItem('hexBreakerNickname2');
        const storedScore = localStorage.getItem('hexBreakerHighScore2');
        const storedPalette = localStorage.getItem('hexBreakerPalette');
        const storedMusic = localStorage.getItem('hexBreakerMusic');
        const storedSfx = localStorage.getItem('hexBreakerSfx');
        const storedLang = localStorage.getItem('hexBreakerLang');
        const storedDiff = localStorage.getItem('hexBreakerDifficulty');

        if (storedLang) { setLanguage(storedLang); } else { setLanguage('en'); }
        if (storedDiff) { currentDifficulty = storedDiff; } else { currentDifficulty = 'hard'; }

        if (storedName && storedName.trim() !== "") {
            playerNickname = storedName;
            nicknameInput.style.display = 'none';
            nicknameShow.style.display = 'block';
            nicknameShow.innerText = playerNickname;
        } else {
            playerNickname = "";
            nicknameInput.style.display = 'block';
            nicknameShow.style.display = 'none';
            nicknameInput.value = ""; 
        }

        if (storedScore && parseInt(storedScore) > 0) {
            highScoreDisplay.style.display = 'block';
            highScoreDisplay.innerText = translations['highScorePrefix'][currentLang] + storedScore;
        }

        if (storedPalette !== null) selectPalette(parseInt(storedPalette));
        if (storedMusic !== null) isMusicOn = (storedMusic === 'true');
        if (storedSfx !== null) isSfxOn = (storedSfx === 'true');
        updateAudioButtons();
    }

    function handleNicknameSave() {
        if (nicknameInput.style.display !== 'none') {
            let val = nicknameInput.value.trim();
            playerNickname = val;
            localStorage.setItem('hexBreakerNickname2', playerNickname);
            if (val !== "") {
                nicknameInput.style.display = 'none';
                nicknameShow.style.display = 'block';
                nicknameShow.innerText = playerNickname;
            }
        }
    }

    // --- OYUN SINIFLARI (OPTIMIZE EDƒ∞LDƒ∞) ---

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 3 + 1;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0; 
            this.decay = 0.03; 
            this.size = Math.random() * 3 + 1; 
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= this.decay;
        }
        draw() {
            ctx.globalAlpha = Math.max(0, this.life); 
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class BombBlast {
        constructor(x, y, maxRadius) {
            this.x = x; this.y = y;
            this.maxRadius = maxRadius;
            this.currentRadius = 10;
            this.life = 1.0;
            this.decay = 0.04;
        }
        update() {
            this.life -= this.decay;
            if (this.currentRadius < this.maxRadius) {
                this.currentRadius += (this.maxRadius - this.currentRadius) * 0.2;
            }
        }
        draw() {
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.currentRadius, 0, Math.PI * 2);
            ctx.lineWidth = 10;
            ctx.strokeStyle = '#FF4500'; 
            ctx.stroke();
            ctx.fillStyle = `rgba(255, 69, 0, ${this.life * 0.3})`;
            ctx.fill();
            ctx.restore();
        }
    }

    class FloatingText {
        constructor(x, y, text, color) {
            this.x = x; this.y = y;
            this.text = text; this.color = color;
            this.life = 1.0; this.dy = -1.5; 
        }
        update() {
            this.y += this.dy;
            this.life -= 0.02; 
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.font = "bold 20px Arial";
            ctx.textAlign = "center";
            ctx.fillText(this.text, this.x, this.y);
            ctx.restore();
        }
    }

    class LaserBeam {
        constructor(x, y, angle) {
            this.x = x; this.y = y;
            this.angle = angle;
            this.life = 1.0; this.decay = 0.05; 
            this.length = Math.max(width, height) * 2; 
        }
        update() { this.life -= this.decay; }
        draw() {
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);
            const beamWidth = 10 + Math.random() * 5; 
            ctx.fillStyle = `rgba(255, 0, 0, ${this.life * 0.8})`; 
            ctx.fillRect(-this.length/2, -beamWidth/2, this.length, beamWidth);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(-this.length/2, -2, this.length, 4);
            ctx.restore();
        }
    }

    class Ball {
        constructor(x, y, radius, color = null) {
            this.x = x; this.y = y;
            this.radius = radius;
            this.color = color || baseColors[Math.floor(Math.random() * baseColors.length)];
            
            this.baseSpeed = 3;
            this.speed = this.baseSpeed;
            
            this.isStar = false; this.isBomb = false; 
            this.isFrozen = false; 
            this.isElectrified = false;
            
            let angle = Math.random() * Math.PI * 2;
            this.dx = Math.cos(angle) * this.speed;
            this.dy = Math.sin(angle) * this.speed; 
        }
        setLaunchAngle() {
            const minAngle = Math.PI / 4;       
            const maxAngle = 3 * Math.PI / 4;   
            let angle = Math.random() * (maxAngle - minAngle) + minAngle;
            this.dx = Math.cos(angle) * this.speed;
            this.dy = -Math.sin(angle) * this.speed;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            if (this.isBomb) {
                const pulse = (Date.now() % 500) / 500;
                ctx.fillStyle = pulse > 0.5 ? '#FF0000' : '#880000';
                ctx.fill();
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 0.4, 0, Math.PI*2);
                ctx.fillStyle = '#000';
                ctx.fill();
            } else if (this.isStar) {
                ctx.save();
                ctx.shadowBlur = 10; 
                ctx.shadowColor = '#FFD700'; 
                ctx.fillStyle = '#FFFFFF';   
                ctx.fill();
                ctx.restore();
            } else if (this.isFrozen) {
                ctx.fillStyle = '#a5feff'; 
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1;
                ctx.stroke();
            } else {
                ctx.fillStyle = this.color;
                ctx.fill();
            }
            ctx.closePath();
        }
        update() {
            if (gameState !== 'PLAYING') return; 
            this.x += this.dx;
            this.y += this.dy;

            if (this.isStar || this.isBomb) { 
                if (Math.random() < 0.3) { 
                    let pColor = '#FFFFFF';
                    if (this.isBomb) pColor = '#FF0000';
                    const trail = new Particle(this.x, this.y, pColor);
                    trail.vx *= 0.2; trail.vy *= 0.2;
                    particles.push(trail);
                }
            }
            if (this.x - this.radius < 0) { this.x = this.radius; this.dx *= -1; }
            else if (this.x + this.radius > width) { this.x = width - this.radius; this.dx *= -1; }
            if (this.y - this.radius < 0) { this.y = this.radius; this.dy *= -1; }
            if (this.y - this.radius > height) { this.dy *= -1; this.y = height - this.radius; }
        }
    }

    class Target {
        constructor(x, y, radius, color, type = 'normal') {
            this.x = x; this.y = y; this.destY = y;     
            this.radius = radius; this.color = color;
            this.type = type; this.active = true;
            this.lifeCount = 1; this.angle = 0;
            
            if (this.type === 'ice_boss') {
                this.hp = 50; 
                this.maxHp = 50;
            } else if (this.type === 'lightning_boss') {
                this.hp = 25;
                this.maxHp = 25;
            } else if (this.type === 'fire_boss') { 
                this.hp = 50;
                this.maxHp = 50;
            } else if (this.type === 'multi') {
                this.lifeCount = Math.floor(Math.random() * 5) + 1;
            } else if (this.type === 'death') {
                this.lifeCount = Math.floor(Math.random() * 5) + 1;
                if (balls.length >= 30) this.lifeCount *= 4;
            }
        }
        update() {
            if (gameState !== 'PLAYING') return;
            if (Math.abs(this.destY - this.y) > 0.5) this.y += (this.destY - this.y) * 0.1; 
            else this.y = this.destY; 
            if (this.type === 'laser') this.angle += 0.01;
        }
        draw() {
            if (!this.active) return;
            
            if (this.type === 'ice_boss') {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.hp, 0, -this.radius - 5);

                ctx.shadowBlur = 20; 
                ctx.shadowColor = '#00FFFF';

                ctx.fillStyle = '#2c3e50'; 
                ctx.fillRect(-this.radius, -this.radius, this.radius * 2, this.radius * 2);

                ctx.strokeStyle = '#00FFFF';
                ctx.lineWidth = 3;
                ctx.strokeRect(-this.radius, -this.radius, this.radius * 2, this.radius * 2);
                
                ctx.shadowBlur = 5; 
                ctx.shadowColor = '#00FFFF';
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '30px Arial'; 
                ctx.textBaseline = 'middle';
                ctx.fillText("‚ùÑ", 0, 1); 

                ctx.restore();
                return;
            }

            if (this.type === 'lightning_boss') {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.hp, 0, -this.radius - 5);

                ctx.shadowBlur = 20; 
                ctx.shadowColor = '#FFFF00'; 

                ctx.fillStyle = '#2c2c2c';
                ctx.fillRect(-this.radius, -this.radius, this.radius * 2, this.radius * 2);

                ctx.strokeStyle = '#FFFF00';
                ctx.lineWidth = 2;
                ctx.strokeRect(-this.radius, -this.radius, this.radius * 2, this.radius * 2);

                ctx.shadowBlur = 10;
                ctx.shadowColor = '#FFFF00';
                ctx.fillStyle = '#FFFF00';
                ctx.font = '14px Arial'; 
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'center'; 
                ctx.fillText("‚ö°", 0, 1); 

                ctx.restore();
                return;
            }

            if (this.type === 'fire_boss') {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.hp, 0, -this.radius - 5);

                ctx.shadowBlur = 20;
                ctx.shadowColor = '#FF4500'; 

                ctx.fillStyle = '#3e0c0c'; 
                ctx.fillRect(-this.radius, -this.radius, this.radius * 2, this.radius * 2);

                ctx.strokeStyle = '#FF4500';
                ctx.lineWidth = 3;
                ctx.strokeRect(-this.radius, -this.radius, this.radius * 2, this.radius * 2);

                ctx.shadowBlur = 10;
                ctx.shadowColor = '#FF4500';
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '18px Arial'; 
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'center';
                ctx.fillText("üî•", 0, 0);

                ctx.restore();
                return;
            }

            if (this.type === 'launch_grant') {
                ctx.save(); ctx.translate(this.x, this.y); 
                ctx.shadowBlur = 10; ctx.shadowColor = '#3498db'; 
                ctx.fillStyle = '#2c3e50'; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#3498db'; ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = '#3498db'; ctx.beginPath();
                ctx.moveTo(0, -this.radius * 0.5); ctx.lineTo(this.radius * 0.35, -this.radius * 0.05); 
                ctx.lineTo(-this.radius * 0.35, -this.radius * 0.05); ctx.fill();
                ctx.beginPath(); ctx.arc(0, this.radius * 0.35, this.radius * 0.18, 0, Math.PI*2); ctx.fill();
                ctx.restore(); return;
            }
            
            if (this.type === 'turn_bomb') {
                ctx.save(); ctx.translate(this.x, this.y);
                ctx.shadowBlur = 10; ctx.shadowColor = '#FF4500';
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#FF4500'; ctx.lineWidth = 3; ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 1, this.radius * 0.55, 0, Math.PI * 2);
                ctx.fillStyle = '#1a1a1a'; ctx.fill(); 
                ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#555'; ctx.fillRect(-this.radius * 0.2, -this.radius * 0.6, this.radius * 0.4, this.radius * 0.2);
                ctx.beginPath(); ctx.moveTo(0, -this.radius * 0.6);
                ctx.quadraticCurveTo(this.radius * 0.4, -this.radius * 0.9, this.radius * 0.5, -this.radius * 0.4);
                ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 2; ctx.stroke();
                ctx.restore(); return;
            }

            if (this.type === 'bomb') {
                ctx.save();
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#FF4500'; 
                ctx.fillStyle = '#333333'; 
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#FF4500'; ctx.lineWidth = 3; ctx.stroke();
                const pulse = (Date.now() % 1000) / 1000; 
                const coreSize = this.radius * (0.6 + Math.sin(pulse * Math.PI * 2) * 0.15); 
                ctx.fillStyle = '#FF4500'; ctx.beginPath(); ctx.arc(this.x, this.y, coreSize, 0, Math.PI*2); ctx.fill();
                ctx.restore(); return;
            }

            if (this.type === 'normal') {
                ctx.save();
                ctx.shadowColor = this.color; 
                ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.fill(); ctx.closePath(); 
                ctx.restore();
                return;
            }
            
            ctx.save();
            ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            
            if (this.type === 'star') {
                ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 10; 
                ctx.fillStyle = '#222'; ctx.fill(); 
                ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = '#FFD700'; ctx.font = '20px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.shadowBlur = 0; ctx.fillText("‚òÖ", this.x, this.y);
            } 
            else if (this.type === 'death') {
                ctx.shadowColor = '#FF0000'; ctx.shadowBlur = 15;
                let grd = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius);
                grd.addColorStop(0, '#880000'); grd.addColorStop(1, '#220000'); 
                ctx.fillStyle = grd; ctx.fill(); ctx.strokeStyle = '#FF0000'; ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = '#FFFFFF'; ctx.font = '900 18px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.shadowBlur = 0; ctx.fillText(this.lifeCount, this.x, this.y + 2); 
            } 
            else if (this.type === 'multi') {
                ctx.shadowColor = '#00FFFF'; ctx.shadowBlur = 15; 
                let grd = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius);
                grd.addColorStop(0, '#004444'); grd.addColorStop(1, '#001122'); 
                ctx.fillStyle = grd; ctx.fill(); ctx.strokeStyle = '#00FFFF'; ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = '#FFFFFF'; ctx.font = '900 18px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.shadowBlur = 0; ctx.fillText(this.lifeCount, this.x, this.y + 2);
            } 
            else if (this.type === 'laser') {
                ctx.shadowColor = '#FF0000'; ctx.shadowBlur = 15;
                ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                ctx.fillStyle = '#220000'; ctx.fill(); ctx.lineWidth = 2; ctx.strokeStyle = '#FF0000'; ctx.stroke();
                ctx.fillStyle = '#FFFFFF'; const barW = this.radius * 0.25; const barL = this.radius * 1.3;
                ctx.fillRect(-barW / 2, -barL / 2, barW, barL); ctx.fillRect(-barL / 2, -barW / 2, barL, barW);
            } 
            else if (this.type === 'rainbow') {
                ctx.shadowColor = '#FFFFFF'; ctx.shadowBlur = 15;
                ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 3; ctx.stroke(); ctx.shadowBlur = 0; 
                const sliceAngle = (Math.PI * 2) / 6;
                for (let i = 0; i < 6; i++) {
                    ctx.beginPath(); ctx.moveTo(this.x, this.y);
                    ctx.arc(this.x, this.y, this.radius, i * sliceAngle, (i + 1) * sliceAngle);
                    ctx.closePath(); ctx.fillStyle = baseColors[i]; ctx.fill();
                }
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius * 0.35, 0, Math.PI * 2);
                ctx.fillStyle = '#FFFFFF'; ctx.fill();
            } 
            else if (this.type === 'time') {
                ctx.shadowColor = '#00FF00'; ctx.shadowBlur = 12;
                ctx.fillStyle = '#002200'; ctx.fill(); ctx.strokeStyle = '#00FF00'; ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = '#00FF00';
                for(let i=0; i<4; i++) {
                    const a = (Math.PI * 2 * i) / 4;
                    const tx = this.x + Math.cos(a) * (this.radius * 0.7);
                    const ty = this.y + Math.sin(a) * (this.radius * 0.7);
                    ctx.beginPath(); ctx.arc(tx, ty, 2, 0, Math.PI*2); ctx.fill();
                }
                ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2; ctx.beginPath();
                ctx.moveTo(this.x, this.y); ctx.lineTo(this.x, this.y - this.radius * 0.5);
                ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.radius * 0.4, this.y + this.radius * 0.2); ctx.stroke();
            } 
            else {
                ctx.shadowColor = this.color;
                ctx.fillStyle = this.color; ctx.fill();
            }
            
            ctx.restore();
            ctx.closePath();
        }
    }
    class Hexagon {
        constructor(x, y, radius) {
            this.x = x; this.y = y; this.radius = radius; this.angle = 0; 
        }
        draw() {
            const segmentAngle = (Math.PI * 2) / 6;
            for (let i = 0; i < 6; i++) {
                ctx.beginPath(); ctx.moveTo(this.x, this.y); 
                let theta1 = this.angle + i * segmentAngle;
                let theta2 = this.angle + (i + 1) * segmentAngle;
                let px1 = this.x + this.radius * Math.cos(theta1);
                let py1 = this.y + this.radius * Math.sin(theta1);
                let px2 = this.x + this.radius * Math.cos(theta2);
                let py2 = this.y + this.radius * Math.sin(theta2);
                ctx.lineTo(px1, py1); ctx.lineTo(px2, py2); ctx.closePath(); 

                let gradient = ctx.createRadialGradient(this.x, this.y, 10, this.x, this.y, this.radius);
                gradient.addColorStop(0, 'white'); 
                gradient.addColorStop(0.3, baseColors[i]); 
                gradient.addColorStop(1, baseColors[i]);   
                ctx.fillStyle = gradient; ctx.fill();
            }
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                let theta = this.angle + i * segmentAngle;
                let px = this.x + this.radius * Math.cos(theta);
                let py = this.y + this.radius * Math.sin(theta);
                ctx.moveTo(this.x, this.y); ctx.lineTo(px, py);
            }
            ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 4; ctx.stroke();
            ctx.beginPath(); ctx.arc(this.x, this.y, this.radius * 0.1, 0, Math.PI*2);
            ctx.fillStyle = '#1a1a1a'; ctx.fill(); ctx.closePath();
        }
    }

    function addScore(points) { score += points; }
    function showFloatingText(x, y, text, color) { floatingTexts.push(new FloatingText(x, y, text, color)); }

    function createExplosion(x, y, color) {
        playSoundEffect('explode');
        for (let i = 0; i < 10; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    function createIceSplinters(x, y) {
        playSoundEffect('hit'); 
        for (let i = 0; i < 8; i++) {
            const color = Math.random() < 0.5 ? '#00FFFF' : '#ffffff';
            let p = new Particle(x, y, color);
            p.vx *= 1.5; 
            p.vy *= 1.5;
            p.size = Math.random() * 2 + 1; 
            p.life = 0.8; 
            particles.push(p);
        }
    }

    function spawnExtraBalls(x, y, color, count, isStar = false) {
        for(let i=0; i<count; i++) {
            let newBall = new Ball(x, y, 7, color);
            if (isStar) newBall.isStar = true;
            balls.push(newBall);
        }
    }

    function spawnRainbowBalls(x, y) {
        for(let i=0; i<6; i++) {
            balls.push(new Ball(x, y, 7, baseColors[i]));
        }
    }

    function launchExtraBall() {
        if (gameState !== 'PLAYING') return;
        if (ballLaunchRights > 0) {
            ballLaunchRights--;
            const randomColor = baseColors[Math.floor(Math.random() * baseColors.length)];
            const startX = width - 50; const startY = height - 255;
            let newBall = new Ball(startX, startY, 7, randomColor);
            const minAngle = -3 * Math.PI / 4; const maxAngle = -Math.PI / 4;
            const angle = Math.random() * (maxAngle - minAngle) + minAngle;
            newBall.dx = Math.cos(angle) * newBall.speed;
            newBall.dy = Math.sin(angle) * newBall.speed;
            balls.push(newBall);
            playSoundEffect('sfx'); 
        }
    }

    function detonateAllBombBalls() {
        if (gameState !== 'PLAYING') return;
        let anyExploded = false;
        for (let i = balls.length - 1; i >= 0; i--) {
            if (balls[i].isBomb) {
                triggerBomb({x: balls[i].x, y: balls[i].y, active: true}); 
                balls.splice(i, 1); anyExploded = true;
            }
        }
        if (anyExploded) checkWinOrLoss();
    }

    function triggerLaser(refTarget) {
        playSoundEffect('laser');
        lasers.push(new LaserBeam(refTarget.x, refTarget.y, refTarget.angle));
        lasers.push(new LaserBeam(refTarget.x, refTarget.y, refTarget.angle + Math.PI/2));

        const threshold = 25; 
        const cosA = Math.cos(-refTarget.angle); const sinA = Math.sin(-refTarget.angle);

        targets.forEach(t => {
            if (t.active && t !== refTarget) {
                const dx = t.x - refTarget.x; const dy = t.y - refTarget.y;
                const rx = dx * cosA - dy * sinA; const ry = dx * sinA + dy * cosA;
                if (Math.abs(ry) < threshold || Math.abs(rx) < threshold) {
                    
                    if (t.type === 'ice_boss') {
                        t.hp -= 10;
                        createIceSplinters(t.x, t.y);
                        showFloatingText(t.x, t.y, "-10", "#FF0000");
                        if(t.hp <= 0) {
                            t.active = false;
                            addScore(1000); 
                            createExplosion(t.x, t.y, '#a5feff');
                            showFloatingText(t.x, t.y, "BOSS DOWN! (+1000)", "#00FFFF");
                        }
                    } else if (t.type === 'lightning_boss') {
                         t.hp -= 10;
                         createExplosion(t.x, t.y, '#FFFF00');
                         showFloatingText(t.x, t.y, "-10", "#FFFF00");
                         if(t.hp <= 0) {
                             t.active = false;
                             addScore(500); 
                             createExplosion(t.x, t.y, '#FFFF00');
                             showFloatingText(t.x, t.y, "BOSS DOWN! (+500)", "#FFFF00");
                         }
                    } else if (t.type === 'fire_boss') { 
                         t.hp -= 10;
                         createExplosion(t.x, t.y, '#FF4500');
                         showFloatingText(t.x, t.y, "-10", "#FF4500");
                         if(t.hp <= 0) {
                             t.active = false;
                             addScore(2000); 
                             createExplosion(t.x, t.y, '#FF4500');
                             showFloatingText(t.x, t.y, "BOSS DOWN! (+2000)", "#FF4500");
                         }
                    } else {
                        t.active = false; createExplosion(t.x, t.y, t.color || '#FFFFFF');
                        if(t.type === 'normal') { addScore(10); showFloatingText(t.x, t.y, "+10", "#FFFFFF"); }
                    }
                }
            }
        });

        for (let i = balls.length - 1; i >= 0; i--) {
            let b = balls[i];
            const dx = b.x - refTarget.x; const dy = b.y - refTarget.y;
            const rx = dx * cosA - dy * sinA; const ry = dx * sinA + dy * cosA;
            if (Math.abs(ry) < threshold || Math.abs(rx) < threshold) {
                createExplosion(b.x, b.y, b.color); showFloatingText(b.x, b.y, getText('floatZap'), "#FF0000"); 
                balls.splice(i, 1);
            }
        }
        checkWinOrLoss();
    }

    function triggerBomb(bombObj) {
        playSoundEffect('bomb');
        const gridW = width / 6; const gridH = ROW_HEIGHT;
        const range = Math.max(gridW, gridH) * 1.25; 
        const rangeSq = range * range;

        bombBlasts.push(new BombBlast(bombObj.x, bombObj.y, range));
        createExplosion(bombObj.x, bombObj.y, '#FF4500');
        showFloatingText(bombObj.x, bombObj.y, getText('floatBoom'), "#FF4500");

        targets.forEach(t => {
            if (t.active) {
                const distSq = (t.x - bombObj.x)**2 + (t.y - bombObj.y)**2;
                if (distSq < rangeSq) {
                    if (t.type === 'ice_boss') {
                        t.hp -= 10;
                        createIceSplinters(t.x, t.y);
                        showFloatingText(t.x, t.y, "-10", "#FF4500");
                        if(t.hp <= 0) {
                            t.active = false;
                            addScore(1000); 
                            createExplosion(t.x, t.y, '#a5feff');
                            showFloatingText(t.x, t.y, "BOSS DOWN! (+1000)", "#00FFFF");
                        }
                    } else if (t.type === 'lightning_boss') {
                         t.hp -= 10;
                         createExplosion(t.x, t.y, '#FFFF00');
                         showFloatingText(t.x, t.y, "-10", "#FFFF00");
                         if(t.hp <= 0) {
                             t.active = false;
                             addScore(500); 
                             createExplosion(t.x, t.y, '#FFFF00');
                             showFloatingText(t.x, t.y, "BOSS DOWN! (+500)", "#FFFF00");
                         }
                    } else if (t.type === 'fire_boss') { 
                         t.hp -= 10;
                         createExplosion(t.x, t.y, '#FF4500');
                         showFloatingText(t.x, t.y, "-10", "#FF4500");
                         if(t.hp <= 0) {
                             t.active = false;
                             addScore(2000); 
                             createExplosion(t.x, t.y, '#FF4500');
                             showFloatingText(t.x, t.y, "BOSS DOWN! (+2000)", "#FF4500");
                         }
                    } else {
                        t.active = false; createExplosion(t.x, t.y, t.color || '#FFFFFF');
                        if(t.type === 'normal') addScore(10);
                        else if (t.type === 'time') { gameTime += 30; showFloatingText(t.x, t.y, "+30s", "#00FF00"); }
                        else if (t.type === 'multi') { spawnExtraBalls(t.x, t.y, '#FFFFFF', 1); showFloatingText(t.x, t.y, getText('floatBallGain'), "#FFFFFF"); }
                        else if (t.type === 'laser') triggerLaser(t);
                        else if (t.type === 'rainbow') spawnRainbowBalls(t.x, t.y);
                        else if (t.type === 'bomb') triggerBomb(t);
                        else if (t.type === 'launch_grant') { ballLaunchRights += 5; showFloatingText(t.x, t.y, getText('floatLaunchGrant'), "#3498db"); }
                    }
                }
            }
        });

        let ballsHit = [];
        for(let i = balls.length - 1; i >= 0; i--) {
            let b = balls[i];
            const distSq = (b.x - bombObj.x)**2 + (b.y - bombObj.y)**2;
            if (distSq < rangeSq) ballsHit.push(b);
        }
        
        ballsHit.forEach(b => {
             const index = balls.indexOf(b);
             if (index > -1) {
                 balls.splice(index, 1); createExplosion(b.x, b.y, b.color);
                 showFloatingText(b.x, b.y, getText('floatBallLost'), "#FF0000"); 
                 if (b.isBomb) triggerBomb({x: b.x, y: b.y, active: true});
             }
        });
        checkWinOrLoss();
    }

    function getPointerPos(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        if (e.changedTouches && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX; clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX; clientY = e.clientY;
        }
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function handleStart(e) {
        if (gameState !== 'PLAYING') return;
        const pos = getPointerPos(e);
        if (pos.y > height * 0.5) {
            isDragging = true;
            lastMouseAngle = Math.atan2(pos.y - hexagon.y, pos.x - hexagon.x);
        }
    }

    function handleMove(e) {
        if (gameState !== 'PLAYING' || !isDragging || !hexagon) return;
        e.preventDefault(); 
        const pos = getPointerPos(e);
        const currentAngle = Math.atan2(pos.y - hexagon.y, pos.x - hexagon.x);
        let delta = currentAngle - lastMouseAngle;
        hexagon.angle += delta;
        lastMouseAngle = currentAngle;
    }

    function handleEnd(e) { isDragging = false; }

    function showMenu() {
        cleanupConfetti(); 
        gameState = 'MENU';
        startScreen.style.display = 'flex';
        gameOverScreen.style.display = 'none';
        uiContainer.style.display = 'none';
        detonateBtn.style.display = 'none'; 
        launchBallBtn.style.display = 'none'; 
        settingsScreen.style.display = 'none';
        infoScreen.style.display = 'none';
        gameOverScreen.style.opacity = 0;
        clearInterval(gameInterval);
        resetGameObjects();
        loadUserData(); 
    }

    function startGame() {
        cleanupConfetti(); 
        startScreen.style.display = 'none';
        gameOverScreen.style.display = 'none';
        uiContainer.style.display = 'flex';
        detonateBtn.style.display = 'flex'; 
        launchBallBtn.style.display = 'flex'; 
        gameOverScreen.style.opacity = 0; 
        gameState = 'PLAYING';
        gameTime = 100.0; score = 0; displayedScore = 0; scoreDisplay.innerText = 0;
        lastTime = 0;
        resetGameObjects();
        startGameTimer();
    }

    function resetGameObjects() {
        const hexRadius = width * 0.4;
        hexagon = new Hexagon(width / 2, height, hexRadius);
        balls = [];
        let startBall = new Ball(width / 2, height * 0.3, 7);
        startBall.setLaunchAngle(); 
        balls.push(startBall);
        targets = []; particles = []; lasers = []; bombBlasts = []; floatingTexts = [];
        hexHitCount = 0; 
        totalBricksAdded = 0;
        
        ballLaunchRights = 0;
        pendingDeathBrick = false; pendingMultiBrick = false; pendingLaserBrick = false;
        pendingRainbowBrick = false; pendingTimeBrick = false; pendingBombBrick = false; 
        pendingStarBrick = false; pendingTurnBombBrick = false; pendingLaunchBrick = false;
        if (gameState === 'PLAYING') spawnNewRow(); 
    }

    function startGameTimer() {
        if (gameInterval) clearInterval(gameInterval);
        gameInterval = setInterval(() => { if (gameState === 'PLAYING') checkAndAddRows(); }, 4000);
    }

    function checkWinOrLoss() {
        if (balls.length === 0) { finishGame(false, 'balls'); return; }
        const activeTargets = targets.filter(t => t.active).length;
        if (totalBricksAdded > 0 && activeTargets === 0) finishGame(true, 'win');
    }

    function celebrateHighScore() {
        const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti-piece');
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
            confetti.style.animationDelay = (Math.random() * 2) + 's';
            document.body.appendChild(confetti);
        }
    }
    function cleanupConfetti() {
        const confettis = document.querySelectorAll('.confetti-piece');
        confettis.forEach(c => c.remove());
    }

    function finishGame(isWin, reason) {
        gameState = 'GAMEOVER';
        clearInterval(gameInterval);
        setTimeout(() => {
            gameOverScreen.style.display = 'flex';
            detonateBtn.style.display = 'none'; 
            launchBallBtn.style.display = 'none';
            requestAnimationFrame(() => { gameOverScreen.style.opacity = 1; });
            if (isWin) {
                gameResultTitle.innerText = getText('winTitle');
                gameResultTitle.className = "win-title";
                scoreDetailsBox.style.display = 'flex';
                const remainingBalls = balls.length;
                const timeLeft = Math.floor(gameTime);
                const timeBonus = timeLeft * 10;
                const ballBonus = remainingBalls * 10;
                const launchBonus = ballLaunchRights * 50;
                const totalFinalScore = score + timeBonus + ballBonus + launchBonus;
                baseScoreDetail.innerText = getText('scoreNormal') + score;
                timeBonusDetail.innerText = getText('scoreTimeBonus') + timeBonus;
                ballBonusDetail.innerText = getText('scoreBallBonus') + ballBonus;
                launchBonusDetail.innerText = getText('scoreLaunchBonus') + launchBonus;
                animateScore(score, totalFinalScore, finalScoreDisplay);
                
                let currentHighScore = parseInt(localStorage.getItem('hexBreakerHighScore2')) || 0;
                highScoreResultDisplay.style.display = 'none';
                if (totalFinalScore > currentHighScore) {
                    localStorage.setItem('hexBreakerHighScore2', totalFinalScore);
                    celebrateHighScore();
                } else {
                    highScoreResultDisplay.innerText = getText('highScorePrefix') + currentHighScore;
                    highScoreResultDisplay.style.display = 'block';
                }
            } else {
                gameResultTitle.className = "lose-title";
                scoreDetailsBox.style.display = 'none'; 
                if (reason === 'time') gameResultTitle.innerText = getText('loseTitleTime');
                else if (reason === 'balls') gameResultTitle.innerText = getText('loseTitleBalls');
                else gameResultTitle.innerText = getText('gameOverTitle');
            }
        }, 1000); 
    }

    function animateScore(start, end, element) {
        let current = start;
        const range = end - start;
        const increment = range > 0 ? Math.ceil(range / 100) : 0; 
        const interval = setInterval(() => {
            current += increment;
            if (current >= end) { current = end; clearInterval(interval); }
            element.innerText = getText('scoreTotal') + current;
        }, 16);
    }

    function spawnNewRow() {
        const zoneWidth = width / 6;
        const targetRadius = Math.min(zoneWidth / 5, 18) * 1;
        
        let deathBrickIndex = -1, multiBrickIndex = -1, laserBrickIndex = -1, rainbowBrickIndex = -1, timeBrickIndex = -1, bombBrickIndex = -1, starBrickIndex = -1, turnBombBrickIndex = -1, launchBrickIndex = -1;
        let iceBossIndex = -1;
        let lightningBossIndex = -1; 
        let fireBossIndex = -1;

        totalBricksAdded += 6; 
        
        const allowedBricks = difficultyConfig[currentDifficulty] || difficultyConfig['hard'];

        if (allowedBricks.includes('fire_boss') && totalBricksAdded > 0 && totalBricksAdded % 198 === 0) {
            fireBossIndex = Math.floor(Math.random() * 6);
        }
        else if (allowedBricks.includes('lightning_boss') && totalBricksAdded > 0 && totalBricksAdded % 36 === 0) {
            lightningBossIndex = Math.floor(Math.random() * 6);
        }
        else if (allowedBricks.includes('ice_boss') && totalBricksAdded > 0 && totalBricksAdded % 66 === 0) {
            iceBossIndex = Math.floor(Math.random() * 6);
        }

        if (allowedBricks.includes('rainbow') && totalBricksAdded % 12 === 0 && Math.random() < 0.5) {
            pendingRainbowBrick = true;
        }

        if (totalBricksAdded % 36 === 0 ) {
            if (allowedBricks.includes('laser') && Math.random() < 0.6) pendingLaserBrick = true;
            if (allowedBricks.includes('bomb') && Math.random() < 0.5) pendingBombBrick = true;
        }

        if (allowedBricks.includes('time') && Math.random() < 0.35) pendingTimeBrick = true;

        if (totalBricksAdded % 12 === 0) {
            if (allowedBricks.includes('multi') && Math.random() < 0.5) pendingMultiBrick = true;
            if (allowedBricks.includes('death') && Math.random() < 0.5) pendingDeathBrick = true;
        }

        if (allowedBricks.includes('star') && totalBricksAdded % 6 === 0 && Math.random() < 0.4) pendingStarBrick = true;

        if (allowedBricks.includes('turn_bomb') && totalBricksAdded % 12 === 0 && Math.random() < 0.5) pendingTurnBombBrick = true;

        if (allowedBricks.includes('launch_grant') && totalBricksAdded % 12 === 0 && Math.random() < 0.5) pendingLaunchBrick = true;


        if (balls.length < 3) pendingDeathBrick = false;
        if (balls.length > 15) { pendingMultiBrick = false; pendingRainbowBrick = false; }
        if (gameTime >= 100) pendingTimeBrick = false;

        let usedIndices = new Set();
        if(iceBossIndex !== -1) usedIndices.add(iceBossIndex); 
        if(lightningBossIndex !== -1) usedIndices.add(lightningBossIndex);
        if(fireBossIndex !== -1) usedIndices.add(fireBossIndex);

        const getUniqueIndex = () => {
             let idx; do { idx = Math.floor(Math.random() * 6); } while(usedIndices.has(idx));
             usedIndices.add(idx); return idx;
        };

        if (pendingDeathBrick && usedIndices.size < 6) deathBrickIndex = getUniqueIndex();
        if (pendingMultiBrick && usedIndices.size < 6) multiBrickIndex = getUniqueIndex();
        if (pendingLaserBrick && usedIndices.size < 6) laserBrickIndex = getUniqueIndex();
        if (pendingRainbowBrick && usedIndices.size < 6) rainbowBrickIndex = getUniqueIndex();
        if (pendingTimeBrick && usedIndices.size < 6) timeBrickIndex = getUniqueIndex();
        if (pendingBombBrick && usedIndices.size < 6) bombBrickIndex = getUniqueIndex();
        if (pendingStarBrick && usedIndices.size < 6) starBrickIndex = getUniqueIndex();
        if (pendingTurnBombBrick && usedIndices.size < 6) turnBombBrickIndex = getUniqueIndex();
        if (pendingLaunchBrick && usedIndices.size < 6) launchBrickIndex = getUniqueIndex();
        
        pendingDeathBrick = false; pendingMultiBrick = false; pendingLaserBrick = false;
        pendingRainbowBrick = false; pendingTimeBrick = false; pendingBombBrick = false; 
        pendingStarBrick = false; pendingTurnBombBrick = false; pendingLaunchBrick = false;

        for (let i = 0; i < 6; i++) {
            const tx = i * zoneWidth + zoneWidth / 2;
            const startY = -50; const destY = 60; 
            let type = 'normal';
            
            if (i === fireBossIndex) type = 'fire_boss';
            else if (i === iceBossIndex) type = 'ice_boss'; 
            else if (i === lightningBossIndex) type = 'lightning_boss'; 
            else if (i === deathBrickIndex) type = 'death';
            else if (i === multiBrickIndex) type = 'multi';
            else if (i === laserBrickIndex) type = 'laser';
            else if (i === rainbowBrickIndex) type = 'rainbow'; 
            else if (i === timeBrickIndex) type = 'time'; 
            else if (i === bombBrickIndex) type = 'bomb'; 
            else if (i === starBrickIndex) type = 'star';
            else if (i === turnBombBrickIndex) type = 'turn_bomb';
            else if (i === launchBrickIndex) type = 'launch_grant';
            
            const color = baseColors[Math.floor(Math.random() * baseColors.length)];
            const newTarget = new Target(tx, startY, targetRadius, color, type);
            newTarget.destY = destY;
            targets.push(newTarget);
        }
    }

    function isSpaceAvailableForNewRow() {
        const limitY = height - (width * 0.4) - 80 - ROW_HEIGHT; 
        return !targets.some(t => t.active && t.destY > limitY);
    }
    function checkAndAddRows() { if (isSpaceAvailableForNewRow()) { shiftTargetsDown(); spawnNewRow(); } }
    function shiftTargetsDown() { targets.forEach(t => { t.destY += ROW_HEIGHT; }); }

    function distToSegmentSquared(px, py, x1, y1, x2, y2) {
        const l2 = (x1 - x2) ** 2 + (y1 - y2) ** 2;
        if (l2 === 0) return (px - x1) ** 2 + (py - y1) ** 2;
        let t = ((px - x1) * (x2 - x1) + (py - y1) * (y2 - y1)) / l2;
        t = Math.max(0, Math.min(1, t));
        return (px - x1 - t * (x2 - x1)) ** 2 + (py - y1 - t * (y2 - y1)) ** 2;
    }

    function checkCollisions() {
        const hasBombBall = balls.some(b => b.isBomb);
        if (hasBombBall) {
            detonateBtn.classList.add('detonate-active'); detonateBtn.style.opacity = ''; 
        } else {
            detonateBtn.classList.remove('detonate-active'); detonateBtn.style.opacity = '0.3';
        }
        launchCountBadge.innerText = ballLaunchRights;
        if (ballLaunchRights > 0) {
            launchBallBtn.classList.add('launch-active'); launchBallBtn.style.opacity = ''; 
        } else {
            launchBallBtn.classList.remove('launch-active'); launchBallBtn.style.opacity = '0.3';
        }

        const hexCheckThreshold = height - (width * 0.5); 

        for (let i = balls.length - 1; i >= 0; i--) {
            let ball = balls[i];
            
            if (ball.y < hexCheckThreshold) {
                for (let j = 0; j < targets.length; j++) {
                    let target = targets[j];
                    if (target.active) {
                        const dx = ball.x - target.x;
                        const dy = ball.y - target.y;
                        const distSq = dx*dx + dy*dy;
                        const combinedRadius = ball.radius + target.radius;
                        const combinedRadiusSq = combinedRadius * combinedRadius;

                        if (distSq <= combinedRadiusSq) {
                            const dist = Math.sqrt(distSq); 
                            let shouldBounce = (target.type !== 'death');

                            if (shouldBounce) {
                                let nx = dx / dist;
                                let ny = dy / dist;
                                ball.x = target.x + nx * combinedRadius;
                                ball.y = target.y + ny * combinedRadius;
                                let dot = ball.dx * nx + ball.dy * ny;
                                ball.dx = ball.dx - 2 * dot * nx;
                                ball.dy = ball.dy - 2 * dot * ny;
                            }
                            
                            playSoundEffect('hit');

                            if (target.type === 'death') {
                                createExplosion(target.x, target.y, '#FF0000'); 
                                showFloatingText(target.x, target.y, getText('floatBallLost'), "#FF0000");
                                balls.splice(i, 1);
                                target.lifeCount--;
                                if(target.lifeCount <= 0) target.active = false;
                                checkWinOrLoss(); 
                                break; 
                            }
                            if (target.type === 'fire_boss') { 
                                if (ball.isFrozen) {
                                    target.hp -= 10;
                                    ball.isFrozen = false; 
                                    ball.dx *= 2; 
                                    ball.dy *= 2;
                                    ball.speed *= 2;
                                    createExplosion(target.x, target.y, '#a5feff'); 
                                    showFloatingText(target.x, target.y, "-10", "#00FFFF");
                                } else {
                                    target.hp -= 1;
                                    createExplosion(target.x, target.y, '#FF4500');
                                    showFloatingText(target.x, target.y, getText('floatBallLost'), "#FF0000");
                                    balls.splice(i, 1); 
                                }
                                
                                if(target.hp <= 0) {
                                    target.active = false;
                                    addScore(2000); 
                                    createExplosion(target.x, target.y, '#FF4500');
                                    showFloatingText(target.x, target.y, "BOSS DOWN! (+2000)", "#FF4500");
                                }
                                checkWinOrLoss();
                                if(!ball.isFrozen) break; 
                                else return; 
                            }
                            if (target.type === 'ice_boss') {
                                if (ball.isElectrified) {
                                    ball.isElectrified = false; 
                                    ball.dx /= 1.25; 
                                    ball.dy /= 1.25; 
                                    ball.speed /= 1.25;
                                }

                                if (ball.isStar) {
                                    target.hp -= 10;
                                    createIceSplinters(target.x, target.y); 
                                    showFloatingText(target.x, target.y, "-10", "#FFD700");
                                } else {
                                    target.hp -= 1; 
                                    createIceSplinters(target.x, target.y);
                                    if (!ball.isFrozen) {
                                        ball.dx *= 0.5;
                                        ball.dy *= 0.5;
                                        ball.speed *= 0.5;
                                        ball.isFrozen = true;
                                    }
                                }
                                if(target.hp <= 0) {
                                    target.active = false;
                                    addScore(1000); 
                                    createExplosion(target.x, target.y, '#a5feff');
                                    showFloatingText(target.x, target.y, "BOSS DOWN! (+1000)", "#00FFFF");
                                }
                                return; 
                            }
                            if (target.type === 'lightning_boss') {
                                if (ball.isStar) {
                                    target.hp -= 10;
                                    showFloatingText(target.x, target.y, "-10", "#FFD700");
                                } else {
                                    if (ball.isFrozen) {
                                         target.hp -= 5;
                                         showFloatingText(target.x, target.y, "-5", "#a5feff");
                                         ball.isFrozen = false; 
                                         ball.speed = ball.baseSpeed; 
                                         let vA = Math.atan2(ball.dy, ball.dx);
                                         ball.dx = Math.cos(vA) * ball.speed;
                                         ball.dy = Math.sin(vA) * ball.speed;
                                    } else {
                                         target.hp -= 1;
                                    }

                                    if (!ball.isElectrified) {
                                        ball.isElectrified = true;
                                        ball.speed = ball.baseSpeed * 1.25;
                                        let angle = Math.atan2(ball.dy, ball.dx);
                                        ball.dx = Math.cos(angle) * ball.speed;
                                        ball.dy = Math.sin(angle) * ball.speed;
                                    }
                                }
                                
                                createExplosion(target.x, target.y, '#FFFF00'); 

                                if(target.hp <= 0) {
                                    target.active = false;
                                    addScore(500); 
                                    createExplosion(target.x, target.y, '#FFFF00');
                                    showFloatingText(target.x, target.y, "BOSS DOWN! (+500)", "#FFFF00");
                                }
                                return;
                            }

                            if (target.type === 'turn_bomb') {
                                target.active = false; createExplosion(target.x, target.y, '#FF4500');
                                ball.isBomb = true; showFloatingText(target.x, target.y, getText('floatBallBomb'), "#FF4500");
                                return;
                            }
                            if (target.type === 'launch_grant') {
                                target.active = false; createExplosion(target.x, target.y, '#3498db');
                                ballLaunchRights += 5; showFloatingText(target.x, target.y, getText('floatLaunchGrant'), "#3498db");
                                return;
                            }
                            if (target.type === 'star') {
                                target.active = false; createExplosion(target.x, target.y, '#FFD700');
                                ball.isStar = true; showFloatingText(target.x, target.y, getText('floatStarPower'), "#FFD700"); 
                                checkWinOrLoss(); return;
                            }
                            if (target.type === 'multi') {
                                createExplosion(target.x, target.y, '#FFFFFF'); 
                                spawnExtraBalls(target.x, target.y, ball.color, 1, ball.isStar);
                                showFloatingText(target.x, target.y, getText('floatBallGain'), "#FFFFFF");
                                target.lifeCount--; if(target.lifeCount <= 0) target.active = false;
                                checkWinOrLoss(); return; 
                            }
                            if (target.type === 'laser') {
                                target.active = false; createExplosion(target.x, target.y, '#FF0000');
                                triggerLaser(target); showFloatingText(target.x, target.y, getText('floatLaser'), "#FF0000"); 
                                return;
                            }
                            if (target.type === 'rainbow') {
                                target.active = false; createExplosion(target.x, target.y, '#FFFFFF');
                                spawnRainbowBalls(target.x, target.y); showFloatingText(target.x, target.y, getText('floatRainbow'), "#FFFFFF"); 
                                checkWinOrLoss(); return;
                            }
                            if (target.type === 'time') {
                                target.active = false; createExplosion(target.x, target.y, '#00FF00');
                                gameTime += 30; showFloatingText(target.x, target.y, "+30s", "#00FF00");
                                checkWinOrLoss(); return;
                            }
                            if (target.type === 'bomb') {
                                target.active = false; triggerBomb(target); return;
                            }

                            if (ball.color === target.color || ball.isStar) {
                                if (target.type === 'normal' && ball.isFrozen) {
                                    continue; 
                                }

                                target.active = false; createExplosion(target.x, target.y, target.color);
                                addScore(10); showFloatingText(target.x, target.y, "+10", "#FFFFFF");
                                checkWinOrLoss();
                            }
                        }
                    }
                } 
            }

            if (!balls[i]) continue;

            if (ball.y > height - (width * 0.6)) { 
                const distToHexCenterSq = (ball.x - hexagon.x)**2 + (ball.y - hexagon.y)**2;
                const checkRadius = hexagon.radius + ball.radius + 20;
                
                if (distToHexCenterSq < checkRadius * checkRadius) {
                    const segmentAngle = (Math.PI * 2) / 6;
                    for (let k = 0; k < 6; k++) {
                        let theta1 = hexagon.angle + k * segmentAngle;
                        let theta2 = hexagon.angle + (k + 1) * segmentAngle;

                        let x1 = hexagon.x + hexagon.radius * Math.cos(theta1);
                        let y1 = hexagon.y + hexagon.radius * Math.sin(theta1);
                        let x2 = hexagon.x + hexagon.radius * Math.cos(theta2);
                        let y2 = hexagon.y + hexagon.radius * Math.sin(theta2);

                        let distSq = distToSegmentSquared(ball.x, ball.y, x1, y1, x2, y2);

                        if (distSq <= ball.radius * ball.radius) {
                            hexHitCount++;
                            
                            ball.color = baseColors[k];
                            
                            if (ball.isFrozen || ball.isElectrified) {
                                ball.isFrozen = false;
                                ball.isElectrified = false;
                                
                                ball.speed = ball.baseSpeed;
                                let vAngle = Math.atan2(ball.dy, ball.dx);
                                ball.dx = Math.cos(vAngle) * ball.speed;
                                ball.dy = Math.sin(vAngle) * ball.speed;
                            }

                            playSoundEffect('hexHit');
                            if(ball.isStar) ball.isStar = false;

                            const dist = Math.sqrt(distSq); 
                            let edgeDx = x2 - x1; let edgeDy = y2 - y1;
                            let nx = -edgeDy; let ny = edgeDx;
                            let len = Math.hypot(nx, ny);
                            nx /= len; ny /= len;

                            let midX = (x1+x2)/2; let midY = (y1+y2)/2;
                            let outX = midX - hexagon.x; let outY = midY - hexagon.y;
                            
                            if (outX*nx + outY*ny < 0) { nx = -nx; ny = -ny; }

                            let overlap = ball.radius - dist;
                            ball.x += nx * (overlap + 1);
                            ball.y += ny * (overlap + 1);

                            let dot = ball.dx * nx + ball.dy * ny;
                            ball.dx = ball.dx - 2 * dot * nx;
                            ball.dy = ball.dy - 2 * dot * ny;
                            break; 
                        }
                    }
                }
            }
        } 
    }

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        
        // Ekran boyutlarƒ±nƒ± al
        width = window.innerWidth; 
        height = window.innerHeight;
        
        // Canvas'ƒ±n i√ß √ß√∂z√ºn√ºrl√ºƒü√ºn√º ayarla (Bulanƒ±klƒ±ƒüƒ± √∂nler)
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        
        // Canvas'ƒ±n CSS boyutunu ayarla (Ekrana sƒ±ƒüdƒ±rƒ±r)
        canvas.style.width = width + 'px'; 
        canvas.style.height = height + 'px';
        
        // √ñNEMLƒ∞: √áizim ayarlarƒ±nƒ± sƒ±fƒ±rla ve yeniden √∂l√ßekle
        // Bu satƒ±r, oyunun sol √ºste k√º√ß√ºlmesini engeller
        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        ctx.scale(dpr, dpr);
        
        // Altƒ±geni (Paddle) ve Topu ekranƒ±n yeni boyutuna g√∂re yeniden konumlandƒ±r
        if (hexagon) { 
             const hexRadius = width * 0.4;
             hexagon.x = width / 2;
             hexagon.y = height;
             hexagon.radius = hexRadius;
        }
        
        // Eƒüer oyun hen√ºz ba≈ülamadƒ±ysa topu merkeze al (isteƒüe baƒülƒ±)
        if (gameState !== 'PLAYING' && balls.length > 0) {
             balls[0].x = width / 2;
             balls[0].y = height * 0.3;
        }
    }

    function loop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const deltaTime = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        if (gameState === 'PLAYING') {
            gameTime -= deltaTime;
            if (gameTime <= 0) { gameTime = 0; finishGame(false, 'time'); }
            timerDisplay.innerText = Math.ceil(gameTime);
            if (gameTime <= 20) timerDisplay.classList.add('low-time');
            else timerDisplay.classList.remove('low-time');
            ballDisplay.innerText = balls.length;
            if (displayedScore < score) { displayedScore += 2; scoreDisplay.innerText = displayedScore; } 
            else if (displayedScore > score) { displayedScore = score; scoreDisplay.innerText = displayedScore; }
        }

        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, width, height);

        if (hexagon) hexagon.draw();
        
        targets.forEach(t => { t.update(); t.draw(); });
        
        for (let i = floatingTexts.length - 1; i >= 0; i--) {
            const ft = floatingTexts[i]; ft.update();
            if (ft.life <= 0) floatingTexts.splice(i, 1); else ft.draw();
        }

        for (let i = lasers.length - 1; i >= 0; i--) {
            const l = lasers[i]; l.update();
            if (l.life <= 0) lasers.splice(i, 1); else l.draw();
        }

        for (let i = bombBlasts.length - 1; i >= 0; i--) {
            const bb = bombBlasts[i]; bb.update();
            if (bb.life <= 0) bombBlasts.splice(i, 1); else bb.draw();
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i]; p.update();
            if (p.life <= 0) particles.splice(i, 1); else p.draw();
        }

        balls.forEach(ball => { ball.update(); ball.draw(); });

        if (gameState === 'PLAYING' && hexagon) checkCollisions();
        
        animationId = requestAnimationFrame(loop);
    }

    function init() {
        window.addEventListener('resize', resize);        
        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', handleEnd);
        resize(); 
        showMenu();        
        requestAnimationFrame(loop);
    }
    init();
</script>
</body>
</html>